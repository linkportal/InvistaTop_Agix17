<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>InvistaTop2 Admin Deploy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 text-white p-4">
    <h2 class="text-xl font-bold mb-6">InvistaTop2 Admin</h2>
    <nav class="space-y-2">
      <button onclick="nav('deploy')" class="active nav-btn w-full text-left px-3 py-2 rounded bg-blue-600">üöÄ Deploy</button>
      <button onclick="nav('dashboard')" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-gray-700">üìä Dashboard</button>
    </nav>
  </aside>

  <!-- Main -->
  <main id="main" class="flex-1 p-8">
    <!-- ===== √ÅREA DEPLOY ===== -->
    <div id="deploy-area" class="space-y-6">
      <!-- Atualizar Banco -->
      <div class="bg-white p-6 rounded shadow">
        <h3 class="text-lg font-bold mb-2">1. Atualizar Banco (InvistaTop2)</h3>
        <button onclick="atualizarBanco()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          üîÑ Atualizar Banco
        </button>
        <div id="bd-result" class="mt-2 text-sm"></div>
      </div>

      <!-- Upload GitHub -->
      <div class="bg-white p-6 rounded shadow">
        <h3 class="text-lg font-bold mb-2">2. Upload para GitHub</h3>
        <input type="password" id="github-token" placeholder="Token GitHub" class="w-full p-2 border rounded mb-2" value="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">
        <input type="text" id="repo-name" placeholder="usu√°rio/reposit√≥rio" class="w-full p-2 border rounded mb-2" value="linkportal/InvistaTop_Agix17">
        <button onclick="uploadGitHub()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
          üì§ Upload GitHub
        </button>
        <div id="github-result" class="mt-2 text-sm"></div>
      </div>
    </div>

    <!-- ===== DASHBOARD ===== -->
    <div id="dashboard-area" class="hidden">
      <h1 class="text-2xl font-bold mb-4">Dashboard - Dados Reais</h1>
      <div id="dashboard-content" class="bg-white p-4 rounded shadow"></div>
    </div>
  </main>
</div>

<script>
// ===== CONFIG =====
const supabase = supabase.createClient(
  'https://bhhynlkstyraemgkjhoe.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ'
);


  // ===== ATUALIZAR BANCO =====
async function atualizarBanco() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Atualizando...';

  const sql = `
CREATE TABLE IF NOT EXISTS niveis_usuario (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(20) UNIQUE NOT NULL,
    comissao_indicacao DECIMAL(5,2) DEFAULT 2.00,
    limite_investimento DECIMAL(15,2) DEFAULT 100000,
    cor_hex VARCHAR(7)
);

INSERT INTO niveis_usuario (nome, comissao_indicacao, limite_investimento, cor_hex) VALUES
('Bronze', 2.00, 10000, '#CD7F32'),
('Silver', 3.00, 50000, '#C0C0C0'),
('Gold', 5.00, 999999, '#FFD700')
ON CONFLICT (nome) DO NOTHING;

CREATE TABLE IF NOT EXISTS perfis (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    nivel_id INTEGER REFERENCES niveis_usuario(id) DEFAULT 1,
    saldo DECIMAL(15,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS projetos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    localizacao VARCHAR(255),
    valor_total DECIMAL(15,2),
    valor_captado DECIMAL(15,2) DEFAULT 0,
    rentabilidade DECIMAL(5,2),
    tempo_investimento INTEGER,
    risco VARCHAR(10) CHECK(risco IN ('Baixo', 'M√©dio', 'Alto')),
    status VARCHAR(15) DEFAULT 'Ativo',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS investimentos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    usuario_id UUID REFERENCES auth.users(id),
    projeto_id UUID REFERENCES projetos(id),
    valor_investido DECIMAL(15,2),
    lucro_atual DECIMAL(15,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transacoes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    usuario_id UUID REFERENCES auth.users(id),
    tipo VARCHAR(20) CHECK(tipo IN ('deposito', 'saque', 'investimento', 'dividendo', 'comissao')),
    valor DECIMAL(15,2),
    status VARCHAR(15) DEFAULT 'pendente',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Pol√≠ticas RLS (se n√£o existirem)
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Usu√°rios veem pr√≥prio perfil') THEN
    ALTER TABLE perfis ENABLE ROW LEVEL SECURITY;
    CREATE POLICY "Usu√°rios veem pr√≥prio perfil" ON perfis FOR SELECT USING (auth.uid() = id);
  END IF;
END $$;
`;

  try {
    const response = await fetch('https://bhhynlkstyraemgkjhoe.supabase.co/rest/v1/rpc/exec_sql', {
      method: 'POST',
      headers: {
        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ sql })
    });

    if (!response.ok) throw new Error(await response.text());
    document.getElementById('bd-result').innerHTML = '<span class="text-green-600">‚úÖ Banco atualizado com sucesso!</span>';
  } catch (err) {
    document.getElementById('bd-result').innerHTML = `<span class="text-red-600">‚ùå Erro: ${err.message}</span>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîÑ Atualizar Banco';
  }
}


// ===== UPLOAD GITHUB =====
async function uploadGitHub() {
  const token = document.getElementById('github-token').value;
  const repo = document.getElementById('repo-name').value;
  const btn = event.target;
  
  if (!token || !repo) return alert('Preencha token e reposit√≥rio');
  
  btn.disabled = true;
  btn.textContent = 'Enviando...';

  const arquivos = {
    'index.html': `<!DOCTYPE html><html><head><title>InvistaTop2</title><script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/@supabase/supabase-js@2"></script></head><body class="bg-gray-50"><nav class="bg-white p-4 shadow"><h1 class="text-xl font-bold text-blue-600">InvistaTop2</h1></nav><div class="p-8 text-center"><h2 class="text-3xl font-bold mb-4">Investimentos Imobili√°rios Inteligentes</h2><button onclick="login()" class="bg-blue-600 text-white px-6 py-2 rounded">Entrar</button></div><script>const sup=supabase.createClient('https://bhhynlkstyraemgkjhoe.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ');async function login(){const{data}=await sup.auth.signInWithPassword({email:'teste@email.com',password:'123456'});if(data.user)window.location.href='dashboard.html';}</script></body></html>`,
    
    'dashboard.html': `<!DOCTYPE html><html><head><title>Dashboard</title><script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/@supabase/supabase-js@2"></script></head><body class="bg-gray-100"><div class="p-8"><h1 class="text-2xl font-bold mb-4">Dashboard</h1><div id="dados" class="bg-white p-4 rounded shadow"></div></div><script>const sup=supabase.createClient('https://bhhynlkstyraemgkjhoe.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ');async function init(){const{data:{user}}=await sup.auth.getUser();if(!user)return;const{data:perf}=await sup.from('perfis').select('*').eq('id',user.id).single();document.getElementById('dados').innerHTML=\`<p>Ol√°, \${perf.nome}</p><p>Saldo: R$ \${perf.saldo.toLocaleString()}</p>\`;}init();</script></body></html>`,
    
    'admin.html': `<!-- C√≥digo completo deste arquivo -->`
  };

  for (const [filename, content] of Object.entries(arquivos)) {
    await fetch(`https://api.github.com/repos/${repo}/contents/${filename}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Deploy InvistaTop2 - ${new Date().toISOString()}`,
        content: btoa(content)
      })
    });
  }
  
  document.getElementById('github-result').innerHTML = 
    `<span class="text-green-600">‚úÖ C√≥digo enviado para https://github.com/${repo}</span>`;
  btn.disabled = false;
  btn.textContent = 'üì§ Upload GitHub';
}

// ===== NAVEGA√á√ÉO =====
function nav(section) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active','bg-blue-600'));
  event.target.classList.add('active','bg-blue-600');
  
  if (section === 'dashboard') {
    document.getElementById('deploy-area').classList.add('hidden');
    document.getElementById('dashboard-area').classList.remove('hidden');
    carregarDashboard();
  } else {
    document.getElementById('deploy-area').classList.remove('hidden');
    document.getElementById('dashboard-area').classList.add('hidden');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  carregarDashboard();
});
</script>
</body>
</html>
