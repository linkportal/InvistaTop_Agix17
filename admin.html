async function atualizarBanco() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Atualizando...';

  const sql = `
CREATE TABLE IF NOT EXISTS niveis_usuario (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(20) UNIQUE NOT NULL,
    comissao_indicacao DECIMAL(5,2) DEFAULT 2.00,
    limite_investimento DECIMAL(15,2) DEFAULT 100000,
    cor_hex VARCHAR(7)
);

INSERT INTO niveis_usuario (nome, comissao_indicacao, limite_investimento, cor_hex) VALUES
('Bronze', 2.00, 10000, '#CD7F32'),
('Silver', 3.00, 50000, '#C0C0C0'),
('Gold', 5.00, 999999, '#FFD700')
ON CONFLICT (nome) DO NOTHING;

CREATE TABLE IF NOT EXISTS perfis (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    nivel_id INTEGER REFERENCES niveis_usuario(id) DEFAULT 1,
    saldo DECIMAL(15,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS projetos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    localizacao VARCHAR(255),
    valor_total DECIMAL(15,2),
    valor_captado DECIMAL(15,2) DEFAULT 0,
    rentabilidade DECIMAL(5,2),
    tempo_investimento INTEGER,
    risco VARCHAR(10) CHECK(risco IN ('Baixo', 'M√©dio', 'Alto')),
    status VARCHAR(15) DEFAULT 'Ativo',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS investimentos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    usuario_id UUID REFERENCES auth.users(id),
    projeto_id UUID REFERENCES projetos(id),
    valor_investido DECIMAL(15,2),
    lucro_atual DECIMAL(15,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transacoes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    usuario_id UUID REFERENCES auth.users(id),
    tipo VARCHAR(20) CHECK(tipo IN ('deposito', 'saque', 'investimento', 'dividendo', 'comissao')),
    valor DECIMAL(15,2),
    status VARCHAR(15) DEFAULT 'pendente',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Pol√≠ticas RLS (se n√£o existirem)
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Usu√°rios veem pr√≥prio perfil') THEN
    ALTER TABLE perfis ENABLE ROW LEVEL SECURITY;
    CREATE POLICY "Usu√°rios veem pr√≥prio perfil" ON perfis FOR SELECT USING (auth.uid() = id);
  END IF;
END $$;
`;

  try {
    const response = await fetch('https://bhhynlkstyraemgkjhoe.supabase.co/rest/v1/rpc/exec_sql', {
      method: 'POST',
      headers: {
        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ sql })
    });

    if (!response.ok) throw new Error(await response.text());
    document.getElementById('bd-result').innerHTML = '<span class="text-green-600">‚úÖ Banco atualizado com sucesso!</span>';
  } catch (err) {
    document.getElementById('bd-result').innerHTML = `<span class="text-red-600">‚ùå Erro: ${err.message}</span>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîÑ Atualizar Banco';
  }
}