<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>InvistaTop2 - Admin Deploy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 text-white p-4">
    <h2 class="text-xl font-bold mb-6">InvistaTop2 Admin</h2>
    <nav class="space-y-2">
      <button onclick="nav('deploy')" class="active nav-btn w-full text-left px-3 py-2 rounded bg-blue-600">üöÄ Deploy</button>
      <button onclick="nav('dashboard')" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-gray-700">üìä Dashboard</button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main id="main" class="flex-1 p-8">
    <div id="deploy-area" class="space-y-6">
      <!-- Bot√£o Atualizar Banco -->
      <div class="bg-white p-6 rounded shadow">
        <h3 class="text-lg font-bold mb-2">Atualizar Banco de Dados</h3>
        <p class="text-sm text-gray-600 mb-4">Cria/altera tabelas sem perder dados existentes</p>
        <button onclick="atualizarBanco()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          üîÑ Atualizar Banco
        </button>
        <div id="bd-result" class="mt-2 text-sm"></div>
      </div>

      <!-- Bot√£o Upload GitHub -->
      <div class="bg-white p-6 rounded shadow">
        <h3 class="text-lg font-bold mb-2">Upload para GitHub</h3>
        <p class="text-sm text-gray-600 mb-4">Enviar c√≥digo para reposit√≥rio</p>
        <input type="password" id="github-token" placeholder="Seu GitHub Token" class="w-full p-2 border rounded mb-2">
        <input type="text" id="repo-name" placeholder="nome/repositorio" class="w-full p-2 border rounded mb-2" value="invistatop/site">
        <button onclick="uploadGitHub()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
          üì§ Upload GitHub
        </button>
        <div id="github-result" class="mt-2 text-sm"></div>
      </div>
    </div>

    <!-- Dashboard Preview -->
    <div id="dashboard-area" class="hidden">
      <h1 class="text-2xl font-bold mb-4">Dashboard - Dados Reais</h1>
      <div id="dashboard-content" class="bg-white p-4 rounded shadow"></div>
    </div>
  </main>
</div>

<script>
// Configura√ß√µes
const supabase = supabase.createClient(
  'https://bhhynlkstyraemgkjhoe.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ'
);

const GITHUB_TOKEN = 'ghp_seu_token_aqui'; // Substitua pelo seu token
const REPO_NAME = 'invistatop/site'; // Substitua pelo seu reposit√≥rio

// Bot√£o Atualizar Banco
async function atualizarBanco() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Atualizando...';
  
  const sql = `
-- ‚úÖ MIGRA√á√ÉO SEGURA INVISTATOP2 (preserva dados)
CREATE TABLE IF NOT EXISTS niveis_usuario (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(20) UNIQUE NOT NULL,
    comissao_indicacao DECIMAL(5,2) DEFAULT 2.00,
    limite_investimento DECIMAL(15,2) DEFAULT 100000,
    cor_hex VARCHAR(7)
);

INSERT INTO niveis_usuario (nome, comissao_indicacao, limite_investimento, cor_hex) VALUES
('Bronze', 2.00, 10000, '#CD7F32'),
('Silver', 3.00, 50000, '#C0C0C0'),
('Gold', 5.00, 999999, '#FFD700')
ON CONFLICT (nome) DO NOTHING;

CREATE TABLE IF NOT EXISTS perfis (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    nivel_id INTEGER REFERENCES niveis_usuario(id) DEFAULT 1,
    saldo DECIMAL(15,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS projetos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    localizacao VARCHAR(255),
    valor_total DECIMAL(15,2),
    valor_captado DECIMAL(15,2) DEFAULT 0,
    rentabilidade DECIMAL(5,2),
    tempo_investimento INTEGER,
    risco VARCHAR(10) CHECK(risco IN ('Baixo', 'M√©dio', 'Alto')),
    status VARCHAR(15) DEFAULT 'Ativo',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS investimentos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    usuario_id UUID REFERENCES auth.users(id),
    projeto_id UUID REFERENCES projetos(id),
    valor_investido DECIMAL(15,2),
    lucro_atual DECIMAL(15,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transacoes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    usuario_id UUID REFERENCES auth.users(id),
    tipo VARCHAR(20) CHECK(tipo IN ('deposito', 'saque', 'investimento')),
    valor DECIMAL(15,2),
    status VARCHAR(15) DEFAULT 'pendente',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE perfis ENABLE ROW LEVEL SECURITY;
ALTER TABLE projetos ENABLE ROW LEVEL SECURITY;
ALTER TABLE investimentos ENABLE ROW LEVEL SECURITY;
ALTER TABLE transacoes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Usu√°rios veem pr√≥prio perfil" ON perfis FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Projetos vis√≠veis para todos" ON projetos FOR SELECT USING (true);
CREATE POLICY "Usu√°rios veem pr√≥prios dados" ON investimentos FOR ALL USING (auth.uid() = usuario_id);
`;

  try {
    const { error } = await supabase.rpc('exec_sql', { sql });
    if (error) throw error;
    
    document.getElementById('bd-result').innerHTML = 
      '<span class="text-green-600">‚úÖ Banco atualizado com sucesso!</span>';
  } catch (err) {
    document.getElementById('bd-result').innerHTML = 
      `<span class="text-red-600">‚ùå Erro: ${err.message}</span>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîÑ Atualizar Banco';
  }
}

// Bot√£o Upload GitHub
async function uploadGitHub() {
  const token = document.getElementById('github-token').value;
  const repo = document.getElementById('repo-name').value;
  const btn = event.target;
  
  if (!token || !repo) {
    alert('Preencha GitHub Token e Nome do Reposit√≥rio');
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Enviando...';
  
  const codigo = {
    'index.html': `<!DOCTYPE html><html><head><title>InvistaTop2</title><script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/@supabase/supabase-js@2"></script></head><body class="bg-gray-50"><nav class="bg-white p-4 shadow"><h1 class="text-xl font-bold text-blue-600">InvistaTop2</h1></nav><div class="p-8 text-center"><h2 class="text-3xl font-bold mb-4">Investimentos Imobili√°rios Inteligentes</h2><button onclick="login()" class="bg-blue-600 text-white px-6 py-2 rounded">Entrar</button></div><script>const sup=supabase.createClient('https://bhhynlkstyraemgkjhoe.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ'); async function login(){const{data}=await sup.auth.signInWithPassword({email:'teste@email.com',password:'123456'});if(data.user)window.location.href='dashboard.html';}</script></body></html>`,
    
    'dashboard.html': `<!DOCTYPE html><html><head><title>Dashboard</title><script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/@supabase/supabase-js@2"></script></head><body class="bg-gray-100"><div class="p-8"><h1 class="text-2xl font-bold mb-4">Dashboard</h1><div id="dados" class="bg-white p-4 rounded shadow"></div></div><script>const sup=supabase.createClient('https://bhhynlkstyraemgkjhoe.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoaHlubGtzdHlyYWVtZ2tqaG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTA5NTAsImV4cCI6MjA2Nzg4Njk1MH0.FnPMp882tTyKwka73jzsgfMfh0nGO4K5pyL34TJtUUQ');async function init(){const{data:{user}}=await sup.auth.getUser();if(!user)return;const{data:perf}=await sup.from('perfis').select('*').eq('id',user.id).single();const{data:inv}=await sup.from('investimentos').select('*,projetos(*)').eq('usuario_id',user.id);const total=inv?.reduce((s,i)=>s+i.valor_investido,0)||0;document.getElementById('dados').innerHTML=\`<p>Ol√°, \${perf.nome}</p><p>Total investido: R$ \${total.toLocaleString()}</p>\`;}init();</script></body></html>`,
    
    'admin.html': `<!-- C√≥digo completo do admin.html j√° criado acima -->`
  };

  try {
    for (const [filename, content] of Object.entries(codigo)) {
      await fetch(`https://api.github.com/repos/${repo}/contents/${filename}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Deploy InvistaTop2 - ${new Date().toISOString()}`,
          content: btoa(content)
        })
      });
    }
    
    document.getElementById('github-result').innerHTML = 
      `<span class="text-green-600">‚úÖ C√≥digo enviado para https://github.com/${repo}</span>`;
  } catch (err) {
    document.getElementById('github-result').innerHTML = 
      `<span class="text-red-600">‚ùå Erro: ${err.message}</span>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'üì§ Upload GitHub';
  }
}

// Navega√ß√£o
function nav(section) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active','bg-blue-600'));
  event.target.classList.add('active','bg-blue-600');
  
  if (section === 'dashboard') {
    document.getElementById('deploy-area').classList.add('hidden');
    document.getElementById('dashboard-area').classList.remove('hidden');
    carregarDashboard();
  } else {
    document.getElementById('deploy-area').classList.remove('hidden');
    document.getElementById('dashboard-area').classList.add('hidden');
  }
}

// Dashboard Admin
async function carregarDashboard() {
  const [usuarios, projetos, transacoes] = await Promise.all([
    supabase.from('perfis').select('count').single(),
    supabase.from('projetos').select('*'),
    supabase.from('transacoes').select('count').single()
  ]);
  
  const totalUsers = usuarios.data.count;
  const totalInvestido = projetos.data?.reduce((s, p) => s + p.valor_captado, 0) || 0;
  const totalTx = transacoes.data.count;
  
  document.getElementById('dashboard-content').innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white p-6 rounded shadow">
        <h3 class="text-sm text-gray-500">Usu√°rios</h3>
        <p class="text-3xl font-bold">${totalUsers}</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3 class="text-sm text-gray-500">Captado</h3>
        <p class="text-3xl font-bold">R$ ${(totalInvestido/1000000).toFixed(1)}M</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3 class="text-sm text-gray-500">Transa√ß√µes</h3>
        <p class="text-3xl font-bold">${totalTx}</p>
      </div>
    </div>
  `;
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
  carregarDashboard();
});
</script>
</body>
</html>
